<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Movie Theater</title>
    <link rel="stylesheet" href="static/movies/css/styles.css" />
  </head>
  <body>
    <header>
      <div class="logo">CinemaTime üé¨</div>
      <nav>
        <ul>
          <li><a href="#now-showing">Now Showing</a></li>
          <li><a href="#contact">Contact</a></li>
        </ul>
      </nav>
    </header>

    <section id="hero">
      <h1>Welcome to CinemaTime</h1>
      <a href="#now-showing" class="btn">Browse Movies</a>
    </section>

    <section id="now-showing">
      <div class="raw">
        <h2>Now Showing</h2>
        <button id="add-movie-btn" class="btn">–î–æ–¥–∞—Ç–∏ —Ñ—ñ–ª—å–º</button>
      </div>
      <div class="movies">
        {% if movies %}
        <ul class="movie-list">
          {% for movie in movies %}
          <li class="movie-card" data-id="{{ movie.Id }}">
            <img class="movie-poster" src="{{ movie.Poster }}" alt="{{ movie.Title }}" />
            <div class="movie-details">
              <strong class="movie-title">{{ movie.Title }}</strong><br />
              <p class="movie-genres">–ñ–∞–Ω—Ä: {{ movie.Genres }}</p>
              <button class="delete-btn">Delete</button>
            </div>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p>No movies available.</p>
        {% endif %}
      </div>

      <div id="add-movie-modal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h2>–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π —Ñ—ñ–ª—å–º</h2>
          <form id="add-movie-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="form-group">
              <label for="id_title">–ù–∞–∑–≤–∞:</label>
              <input type="text" name="title" id="id_title" class="form-control" required>
            </div>
      
            <div class="form-group">
              <label for="id_description">–û–ø–∏—Å:</label>
              <textarea name="description" id="id_description" class="form-control"></textarea>
            </div>
      
            <div class="form-group">
              <label for="id_poster">URL –ø–æ—Å—Ç–µ—Ä–∞:</label>
              <input type="url" name="poster" id="id_poster" class="form-control">
            </div>
      
            <div class="form-group">
              <label for="id_year">–†—ñ–∫ –≤–∏—Ö–æ–¥—É:</label>
              <input type="number" name="year" id="id_year" class="form-control" required>
            </div>
      
            <div class="form-group">
              <label for="id_country">–ö—Ä–∞—ó–Ω–∞:</label>
              <input type="text" name="country" id="id_country" class="form-control" required>
            </div>
      
            <div class="form-group">
              <label for="id_directors">–†–µ–∂–∏—Å–µ—Ä–∏:</label>
              <textarea name="directors" id="id_directors" class="form-control" required></textarea>
            </div>
      
            <div class="form-group">
              <label for="id_actors">–ê–∫—Ç–æ—Ä–∏:</label>
              <textarea name="actors" id="id_actors" class="form-control"></textarea>
            </div>
      
            <div class="form-group">
              <label for="id_genres">–ñ–∞–Ω—Ä–∏:</label>
              <select name="genres" id="id_genres" class="form-control" multiple required>
                {% for genre in genres %}
                  <option value="{{ genre.id }}">{{ genre.name }}</option>
                {% empty %}
                  <option value="" disabled>No genres available</option>
                {% endfor %}
              </select>
            </div>
          
            
            <div class="form-group">
              <label for="id_category">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:</label>
              <select name="category" id="id_category" class="form-control" required>
                {% for category in categories %}
                  <option value="{{ category.id }}">{{ category.name }}</option>
                {% empty %}
                  <option value="" disabled>No categories available</option>
                {% endfor %}
              </select>
            </div>
      
            <button type="submit" class="btn">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
          </form>
        </div>
      </div>
    </section>

    <footer id="contact">
      <p>Contact us: support@cinematime.com | Phone: +1 (123) 456-7890</p>
      <p>&copy; 2024 CinemaTime. All rights reserved.</p>
    </footer>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
          const deleteButtons = document.querySelectorAll('.delete-btn');
    
          deleteButtons.forEach(button => {
              button.addEventListener('click', async function (event) {
                  const movieCard = event.target.closest('.movie-card');
    
                  // –î–æ–¥–∞—Ç–∫–æ–≤–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –¥–µ–±–∞–≥—É
                  if (!movieCard) {
                      console.error("Movie card not found.");
                      alert("An error occurred. Try again later.");
                      return;
                  }
    
                  const movieId = movieCard.dataset.id;
    
                  if (!movieId) {
                      console.error("Movie ID is undefined.");
                      alert("Unable to delete movie. Movie ID is missing.");
                      return;
                  }
    
                  if (confirm("Are you sure you want to delete this movie?")) {
                      try {
                          const response = await fetch(`/api/admin/movies/${movieId}/`, {
                              method: 'DELETE',
                              headers: {
                                  'X-CSRFToken': getCookie('csrftoken'),
                                  'Content-Type': 'application/json'
                              }
                          });
    
                          if (response.ok) {
                              movieCard.remove();
                              alert("Movie deleted successfully.");
                          } else {
                              const errorText = await response.text();
                              console.error("Failed to delete movie:", errorText);
                              alert("Failed to delete the movie. Please try again.");
                          }
                      } catch (error) {
                          console.error("Network error:", error);
                          alert("An error occurred while trying to delete the movie.");
                      }
                  }
              });
          });
    
          function getCookie(name) {
              let cookieValue = null;
              if (document.cookie && document.cookie !== '') {
                  const cookies = document.cookie.split(';');
                  for (let i = 0; i < cookies.length; i++) {
                      const cookie = cookies[i].trim();
                      if (cookie.startsWith(name + '=')) {
                          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                          break;
                      }
                  }
              }
              return cookieValue;
          }
      });
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('add-movie-modal');
        const openModalBtn = document.getElementById('add-movie-btn');
        const closeModalBtn = document.querySelector('.close');
    
        // –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
        openModalBtn.addEventListener('click', () => {
          modal.style.display = 'block';
        });
    
        // –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
        closeModalBtn.addEventListener('click', () => {
          modal.style.display = 'none';
        });
    
        // –ó–∞–∫—Ä–∏—Ç—Ç—è –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –ø–æ–∑–∞ –º–æ–¥–∞–ª—å–Ω–∏–º –≤—ñ–∫–Ω–æ–º
        window.addEventListener('click', (event) => {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });
      });

      document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('add-movie-form');
        form.addEventListener('submit', async function (event) {
            event.preventDefault(); // –∑–∞–ø–æ–±—ñ–≥–∞—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—é —Ñ–æ—Ä–º–∏
    
            const formData = new FormData(form);
    
            try {
                const response = await fetch('/api/admin/movies/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken') // –ø–µ—Ä–µ–¥–∞—á–∞ CSRF —Ç–æ–∫–µ–Ω—É
                    }
                });
    
                if (response.ok) {
                    window.location.reload();
                    alert("–§—ñ–ª—å–º —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!");
                    modal.style.display = 'none'; 
                    // –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –∫–æ–¥ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —Ñ—ñ–ª—å–º—ñ–≤
                } else {
                    const errorText = await response.text();
                    alert("–ü–æ–º–∏–ª–∫–∞: " + errorText);
                }
            } catch (error) {
                console.error("Network error:", error);
                
            }
        });
    
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
    </script>
  </body>
</html>
